name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Haskell Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'

      - name: Cache Stack global package DB
        uses: actions/cache@v4
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml.lock') }}
          restore-keys: |
            ${{ runner.os }}-stack-global-

      - name: Cache Stack work directory
        uses: actions/cache@v4
        with:
          path: .stack-work
          key: ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock', 'package.yaml', '**/*.hs') }}
          restore-keys: |
            ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock', 'package.yaml') }}
            ${{ runner.os }}-stack-work-

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install sqlite3

      # Restore file timestamps to prevent unnecessary rebuilds
      - name: Restore file timestamps
        run: |
          git ls-files -z | while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              timestamp=$(git log -1 --format='%ci' -- "$file" 2>/dev/null || echo "")
              if [ -n "$timestamp" ]; then
                touch -d "$timestamp" "$file" 2>/dev/null || true
              fi
            fi
          done

      # Build dependencies first (better caching)
      - name: Build dependencies
        run: make deps

      # Run full CI build (warnings as errors + tests)
      - name: Run CI build
        run: make ci

      - name: Check that argus binary runs
        run: |
          stack exec -- argus --help
          stack exec -- argus --version || true

      - name: Generate build summary
        if: always()
        run: |
          echo "## Build Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- CI build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- Zero warnings (enforced via -Werror)" >> $GITHUB_STEP_SUMMARY

  self-lint:
    name: Self Lint
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Haskell Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'

      - name: Cache Stack global package DB
        uses: actions/cache@v4
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml.lock') }}
          restore-keys: |
            ${{ runner.os }}-stack-global-

      - name: Cache Stack work directory
        uses: actions/cache@v4
        with:
          path: .stack-work
          key: ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock', 'package.yaml', '**/*.hs') }}
          restore-keys: |
            ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock', 'package.yaml') }}
            ${{ runner.os }}-stack-work-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev

      # Restore file timestamps
      - name: Restore file timestamps
        run: |
          git ls-files -z | while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              timestamp=$(git log -1 --format='%ci' -- "$file" 2>/dev/null || echo "")
              if [ -n "$timestamp" ]; then
                touch -d "$timestamp" "$file" 2>/dev/null || true
              fi
            fi
          done

      - name: Build project
        run: make dev

      - name: Run Argus on itself
        run: make lint 2>&1 | tee lint-results.txt || true

      - name: Run Argus SARIF output
        continue-on-error: true
        run: |
          stack exec -- argus check src/ app/ --format sarif > lint-results.sarif 2>&1 || true
          if [ -f lint-results.sarif ] && [ -s lint-results.sarif ]; then
            if ! python3 -m json.tool lint-results.sarif > /dev/null 2>&1; then
              rm -f lint-results.sarif
            fi
          fi

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && hashFiles('lint-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: lint-results.sarif
          category: argus-self-lint

      - name: Generate lint summary
        if: always()
        run: |
          echo "## Self-Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f lint-results.txt ]; then
            ISSUES=$(grep -cE "^\s*(warning|error):" lint-results.txt || echo "0")
            if [ "$ISSUES" = "0" ]; then
              echo "No issues found." >> $GITHUB_STEP_SUMMARY
            else
              echo "Found **$ISSUES** issue(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            lint-results.txt
            lint-results.sarif
          retention-days: 7

  haddock:
    name: Documentation
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Haskell Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'

      - name: Cache Stack global package DB
        uses: actions/cache@v4
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml.lock') }}
          restore-keys: |
            ${{ runner.os }}-stack-global-

      - name: Cache Stack work directory
        uses: actions/cache@v4
        with:
          path: .stack-work
          key: ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock', 'package.yaml', '**/*.hs') }}
          restore-keys: |
            ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock', 'package.yaml') }}
            ${{ runner.os }}-stack-work-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev

      - name: Restore file timestamps
        run: |
          git ls-files -z | while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              timestamp=$(git log -1 --format='%ci' -- "$file" 2>/dev/null || echo "")
              if [ -n "$timestamp" ]; then
                touch -d "$timestamp" "$file" 2>/dev/null || true
              fi
            fi
          done

      - name: Build Haddock documentation
        run: stack haddock --fast --no-haddock-deps

      - name: Documentation summary
        run: |
          echo "## Documentation" >> $GITHUB_STEP_SUMMARY
          echo "Haddock documentation built successfully." >> $GITHUB_STEP_SUMMARY

  sdist:
    name: Source Distribution
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Haskell Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'

      - name: Cache Stack global package DB
        uses: actions/cache@v4
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml.lock') }}
          restore-keys: |
            ${{ runner.os }}-stack-global-

      - name: Build source distribution
        run: stack sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: .stack-work/dist/**/*.tar.gz
          retention-days: 7
