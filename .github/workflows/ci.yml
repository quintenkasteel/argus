name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install sqlite3

      # Use freckle/stack-action for automatic caching and best practices
      # See: https://github.com/freckle/stack-action
      - name: Build and Test
        uses: freckle/stack-action@v5
        with:
          stack-build-arguments: >-
            --ghc-options "-Werror -j +RTS -A128m -n2m -RTS"
          cache-save-always: true

      - name: Check that argus binary runs
        run: |
          stack exec -- argus --help
          stack exec -- argus --version || true

      - name: Generate build summary
        if: always()
        run: |
          echo "## Build Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- CI build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- Zero warnings (enforced via -Werror)" >> $GITHUB_STEP_SUMMARY

  self-lint:
    name: Self Lint
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev

      - name: Build project
        uses: freckle/stack-action@v5
        with:
          test: false
          stack-build-arguments: --fast

      - name: Run Argus on itself
        run: stack exec -- argus check src/ app/ 2>&1 | tee lint-results.txt || true

      - name: Run Argus SARIF output
        continue-on-error: true
        run: |
          stack exec -- argus check src/ app/ --format sarif > lint-results.sarif 2>&1 || true
          if [ -f lint-results.sarif ] && [ -s lint-results.sarif ]; then
            if ! python3 -m json.tool lint-results.sarif > /dev/null 2>&1; then
              rm -f lint-results.sarif
            fi
          fi

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && hashFiles('lint-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: lint-results.sarif
          category: argus-self-lint

      - name: Generate lint summary
        if: always()
        run: |
          echo "## Self-Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f lint-results.txt ]; then
            ISSUES=$(grep -cE "^\s*(warning|error):" lint-results.txt || echo "0")
            if [ "$ISSUES" = "0" ]; then
              echo "No issues found." >> $GITHUB_STEP_SUMMARY
            else
              echo "Found **$ISSUES** issue(s)." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            lint-results.txt
            lint-results.sarif
          retention-days: 7

  haddock:
    name: Documentation
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev

      - name: Build with freckle/stack-action
        uses: freckle/stack-action@v5
        with:
          test: false
          stack-build-arguments: --fast --no-run-tests

      - name: Build Haddock documentation
        run: stack haddock --fast --no-haddock-deps

      - name: Documentation summary
        run: |
          echo "## Documentation" >> $GITHUB_STEP_SUMMARY
          echo "Haddock documentation built successfully." >> $GITHUB_STEP_SUMMARY

  sdist:
    name: Source Distribution
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Stack
        uses: freckle/stack-action@v5
        with:
          test: false
          stack-build-arguments: --fast --no-run-tests

      - name: Build source distribution
        run: stack sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: .stack-work/dist/**/*.tar.gz
          retention-days: 7
