name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Prerelease suffix (optional, e.g., rc1, beta, alpha)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          # Extract current version from package.yaml
          CURRENT_VERSION=$(grep '^version:' package.yaml | sed 's/version: *"\?\([^"]*\)"\?/\1/')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

          # Parse semver components
          MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3 | cut -d- -f1)

          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: new
        run: |
          MAJOR=${{ steps.current.outputs.major }}
          MINOR=${{ steps.current.outputs.minor }}
          PATCH=${{ steps.current.outputs.patch }}
          BUMP_TYPE="${{ github.event.inputs.bump_type }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"

          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          if [ -n "$PRERELEASE" ]; then
            NEW_VERSION="${NEW_VERSION}-${PRERELEASE}"
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Check if tag already exists
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"

          if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
            echo "::error::Tag v${NEW_VERSION} already exists!"
            exit 1
          fi

          echo "Tag v${NEW_VERSION} is available"

      - name: Update package.yaml
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"

          # Update version in package.yaml
          sed -i "s/^version: .*/version: \"${NEW_VERSION}\"/" package.yaml

          echo "Updated package.yaml:"
          grep '^version:' package.yaml

      - name: Update CHANGELOG.md
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          DATE=$(date +%Y-%m-%d)

          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'CHANGELOG_EOF'
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          ## [Unreleased]
          CHANGELOG_EOF
          fi

          # Create the new version entry
          NEW_ENTRY="## [${NEW_VERSION}] - ${DATE}

          ### Changed
          - Version bump from ${CURRENT_VERSION} to ${NEW_VERSION}
          "

          # Insert after ## [Unreleased] line
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            # Use awk to insert after Unreleased section
            awk -v new_entry="$NEW_ENTRY" '
              /^## \[Unreleased\]/ {
                print
                print ""
                print new_entry
                next
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.md.tmp
            mv CHANGELOG.md.tmp CHANGELOG.md
          else
            # No Unreleased section, insert after the header
            awk -v new_entry="$NEW_ENTRY" '
              /^## \[/ && !done {
                print new_entry
                print ""
                done = 1
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.md.tmp
            mv CHANGELOG.md.tmp CHANGELOG.md
          fi

          echo "Updated CHANGELOG.md"
          head -30 CHANGELOG.md

      - name: Show changes (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "=== DRY RUN ==="
          echo ""
          echo "Would commit the following changes:"
          git diff
          echo ""
          echo "Would create tag: v${{ steps.new.outputs.version }}"
          echo ""
          echo "=== END DRY RUN ==="

      - name: Commit changes
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"

          git add package.yaml CHANGELOG.md
          git commit -m "chore: bump version to ${NEW_VERSION}

          Automated version bump from ${{ steps.current.outputs.version }} to ${NEW_VERSION}
          Bump type: ${{ github.event.inputs.bump_type }}"

      - name: Create and push tag
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"

          git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin "v${NEW_VERSION}"

          echo "Pushed version ${NEW_VERSION} and tag v${NEW_VERSION}"

      - name: Summary
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          echo "## Version Bump Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Version | ${{ steps.current.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | ${NEW_VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | ${{ github.event.inputs.bump_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prerelease | ${{ github.event.inputs.prerelease || 'none' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${DRY_RUN} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" != "true" ]; then
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The release workflow will now automatically:" >> $GITHUB_STEP_SUMMARY
            echo "1. Build binaries for all platforms" >> $GITHUB_STEP_SUMMARY
            echo "2. Run the full test suite" >> $GITHUB_STEP_SUMMARY
            echo "3. Publish to Hackage (if credentials configured)" >> $GITHUB_STEP_SUMMARY
            echo "4. Create a GitHub Release with artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View Release Workflow](https://github.com/${{ github.repository }}/actions/workflows/release.yml)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**This was a dry run. No changes were made.**" >> $GITHUB_STEP_SUMMARY
          fi
